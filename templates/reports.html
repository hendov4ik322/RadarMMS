<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Отчёты</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metrics { display:flex; gap:20px; justify-content:center; margin:20px 0; }
        .metric { text-align:center; padding:10px 15px; background:#1e1e1e; border-radius:8px; }
        .metric .number { font-size:20px; font-weight:700; }
    .chart-container { background:#121212; padding:12px; border-radius:8px; position:relative; }
        table { width:100%; border-collapse:collapse; margin-top:20px; }
        th, td { padding:8px 10px; border-bottom:1px solid #2b2b2b; }
        thead th { background:#151515; cursor:pointer; }
        canvas { max-height:100%; }
        /* Canvas wrapper to position overlay exactly over chart area */
        .chart-canvas-wrap { position: relative; height: 140px; }
        /* No-data message styling: centered overlay inside the canvas wrapper */
        .reports-page .no-data-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none; /* shown only when no data */
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background: rgba(0,0,0,0.65);
            color: #fff;
            font-style: normal;
            border-radius: 6px;
            pointer-events: none;
            z-index: 10;
            text-align: center;
            min-width: 80px;
        }
    </style>
</head>
<body>
<div class="container reports-page">
    <h1 style="text-align:center;">Отчёты</h1>
    <div style="text-align:center; margin-bottom:12px;"><a href="{{ url_for('index') }}">← Назад к задачам</a></div>

    <!-- Метрики -->
    <div class="metrics">
        <div class="metric">
            <div class="number">{{ total|default(0) }}</div>
            <div class="label">Всего задач</div>
        </div>
        <div class="metric">
            <div class="number" style="color:var(--accent-green);">{{ completed|default(0) }}</div>
            <div class="label">Выполнено</div>
        </div>
        <div class="metric">
            <div class="number" style="color:var(--accent-red);">{{ overdue|default(0) }}</div>
            <div class="label">Просрочено</div>
        </div>
        <div class="metric">
            <div class="number">{{ (total|default(0) - completed|default(0)) }}</div>
            <div class="label">Не выполнено</div>
        </div>
    </div>

    <!-- Top charts: two bar charts in row and one doughnut below -->
    <div class="charts" style="margin:12px 0;display:flex;flex-wrap:wrap;gap:16px;justify-content:center;">
        <!-- Bar charts row -->
        <div style="display:flex;width:100%;gap:16px;justify-content:center;margin-bottom:16px;">
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
                <h3 style="text-align:center;margin:0 0 8px 0;">Распределение по статусам</h3>
                <div class="chart-canvas-wrap" style="height:140px;">
                    <canvas id="statusChartTop"></canvas>
                    <div id="statusNoDataTop" class="no-data-message">Нет данных для отображения</div>
                </div>
            </div>
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
                <h3 style="text-align:center;margin:0 0 8px 0;">Распределение по приоритетам</h3>
                <div class="chart-canvas-wrap" style="height:140px;">
                    <canvas id="priorityChartTop"></canvas>
                    <div id="priorityNoDataTop" class="no-data-message">Нет данных для отображения</div>
                </div>
            </div>
        </div>
        <!-- Doughnut chart below -->
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
            <h3 style="text-align:center;margin:0 0 8px 0;">Просроченные задачи</h3>
            <div class="chart-canvas-wrap" style="height:140px;">
                <canvas id="overdueChartTop"></canvas>
                <div id="overdueNoDataTop" class="no-data-message">Нет данных для отображения</div>
            </div>
        </div>
    </div>

    <!-- Таблица задач -->
    <h2 style="text-align:center; margin-top:36px;">Задачи</h2>
    <div style="text-align:center; margin:12px 0;">
        <label>Исполнитель: 
            <select id="assigneeFilter">
                <option value="">Все</option>
                {% for a in assignees %}
                <option value="{{ a }}">{{ a }}</option>
                {% endfor %}
            </select>
        </label>
        &nbsp;&nbsp;
        <label>Статус: 
            <select id="statusFilter">
                <option value="">Все</option>
                {% for s in statuses %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>
        </label>
    </div>

    <table id="tasksTable">
        <thead>
            <tr>
                <th data-type="number">ID</th>
                <th data-type="string">Название</th>
                <th data-type="string">Исполнитель</th>
                <th data-type="string">Приоритет</th>
                <th data-type="date">Срок</th>
                <th data-type="string">Статус</th>
            </tr>
        </thead>
        <tbody id="tasksBody">
            <!-- filled by JS -->
        </tbody>
    </table>

</div>

<!-- Embed JSON data safely (use fallbacks when vars undefined) -->
    <!-- Charts below the table (same structure as top) -->
    <div class="charts" style="margin:20px 0;display:flex;flex-wrap:wrap;gap:16px;justify-content:center;">
        <!-- Bar charts row -->
        <div style="display:flex;width:100%;gap:16px;justify-content:center;margin-bottom:16px;">
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
                <h3 style="text-align:center;margin:0 0 8px 0;">Распределение по статусам (по таблице)</h3>
                <div class="chart-canvas-wrap" style="height:140px;">
                    <canvas id="statusChartBottom"></canvas>
                    <div id="statusNoData" class="no-data-message" style="display:none;">Нет данных для отображения</div>
                </div>
            </div>
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
                <h3 style="text-align:center;margin:0 0 8px 0;">Распределение по приоритетам (по таблице)</h3>
                <div class="chart-canvas-wrap" style="height:140px;">
                    <canvas id="priorityChartBottom"></canvas>
                    <div id="priorityNoData" class="no-data-message" style="display:none;">Нет данных для отображения</div>
                </div>
            </div>
        </div>
        <!-- Doughnut chart below -->
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
            <h3 style="text-align:center;margin:0 0 8px 0;">Просроченные задачи (по таблице)</h3>
            <div class="chart-canvas-wrap" style="height:140px;">
                <canvas id="overdueChartBottom"></canvas>
                <div id="overdueNoData" class="no-data-message" style="display:none;">Нет данных для отображения</div>
            </div>
        </div>
    </div>
{% if status_counts is defined %}
<script id="status-data" type="application/json">{{ status_counts | tojson | safe }}</script>
{% else %}
<script id="status-data" type="application/json">{}</script>
{% endif %}

{% if priority_counts is defined %}
<script id="priority-data" type="application/json">{{ priority_counts | tojson | safe }}</script>
{% else %}
<script id="priority-data" type="application/json">{}</script>
{% endif %}

{% if tasks is defined %}
<script id="tasks-data" type="application/json">{{ tasks | tojson | safe }}</script>
{% else %}
<script id="tasks-data" type="application/json">[]</script>
{% endif %}

<script>
// Read embedded JSON
const statusData = JSON.parse(document.getElementById('status-data').textContent || '{}');
const priorityData = JSON.parse(document.getElementById('priority-data').textContent || '{}');
const tasks = JSON.parse(document.getElementById('tasks-data').textContent || '[]');

// Utility: render table body from tasks list
function renderTable(list){
    const tbody = document.getElementById('tasksBody');
    tbody.innerHTML = '';
    list.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${t.id}</td>
            <td><a href="/task/${t.id}">${escapeHtml(t.title||'')}</a></td>
            <td>${escapeHtml(t.assignee||'—')}</td>
            <td>${escapeHtml(t.priority||'')}</td>
            <td>${escapeHtml(t.due_date||'')}</td>
            <td>${escapeHtml(t.status||'')}</td>
        `;
        tbody.appendChild(tr);
    });
}

function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; });
}

// Filters
const assigneeFilter = document.getElementById('assigneeFilter');
const statusFilter = document.getElementById('statusFilter');
assigneeFilter.addEventListener('change', applyFilters);
statusFilter.addEventListener('change', applyFilters);

function applyFilters(){
    const a = assigneeFilter.value;
    const s = statusFilter.value;
    const filtered = tasks.filter(t=>{
        if(a && (t.assignee||'') !== a) return false;
        if(s && (t.status||'') !== s) return false;
        return true;
    });
    renderTable(filtered);
    updateChartsFromTasks(filtered);
}

// Update bottom charts based on filtered tasks
function updateChartsFromTasks(list){
    const sc = {};
    const pc = {};
    const overdueByAssignee = {};
    const now = new Date(); now.setHours(0,0,0,0);
    list.forEach(t=>{
        const status = t.status || '—'; sc[status] = (sc[status]||0)+1;
        const pr = t.priority || '—'; pc[pr] = (pc[pr]||0)+1;
        if(t.due_date && t.status !== 'Готово'){
            const due = new Date(t.due_date);
            if(due < now){ const a = t.assignee||'Не назначен'; overdueByAssignee[a] = (overdueByAssignee[a]||0)+1; }
        }
    });

    // update status chart
    const hasStatus = Object.values(sc).length > 0;
    const statusCanvas = document.getElementById('statusChartBottom');
    // show overlay message on top of the chart when no data
    const statusOverlay = document.getElementById('statusNoData');
    statusOverlay.style.display = hasStatus ? 'none' : 'flex';
    statusCanvas.style.opacity = hasStatus ? '1' : '0.35';
    statusChart.data.labels = Object.keys(sc);
    statusChart.data.datasets[0].data = Object.values(sc);
    statusChart.update();

    // update priority chart
    const hasPriority = Object.values(pc).length > 0;
    const priorityCanvas = document.getElementById('priorityChartBottom');
    const priorityOverlay = document.getElementById('priorityNoData');
    priorityOverlay.style.display = hasPriority ? 'none' : 'flex';
    priorityCanvas.style.opacity = hasPriority ? '1' : '0.35';
    priorityChart.data.labels = Object.keys(pc);
    priorityChart.data.datasets[0].data = Object.values(pc);
    priorityChart.update();

    // update overdue chart
    const hasOverdue = Object.values(overdueByAssignee).length > 0;
    const overdueCanvas = document.getElementById('overdueChartBottom');
    const overdueOverlay = document.getElementById('overdueNoData');
    overdueOverlay.style.display = hasOverdue ? 'none' : 'flex';
    overdueCanvas.style.opacity = hasOverdue ? '1' : '0.35';
    overdueChart.data.labels = Object.keys(overdueByAssignee);
    overdueChart.data.datasets[0].data = Object.values(overdueByAssignee);
    overdueChart.update();
}

// compute overdue by assignee for TOP charts (global)
const overdueTasksTop = tasks.filter(t => t && t.due_date && t.status !== 'Готово' && new Date(t.due_date) < new Date(new Date().setHours(0,0,0,0)));
const overdueByAssigneeTop = {};
overdueTasksTop.forEach(t => {
    const a = t.assignee || 'Не назначен';
    overdueByAssigneeTop[a] = (overdueByAssigneeTop[a] || 0) + 1;
});

// Initialize TOP charts (2 bars and 1 doughnut)
const statusCtxTop = document.getElementById('statusChartTop').getContext('2d');
const statusChartTop = new Chart(statusCtxTop, {
    type: 'bar',
    data: { labels: Object.keys(statusData), datasets: [{ 
        label:'Количество задач',
        data: Object.values(statusData), 
        backgroundColor: ['#2196F3','#FF9800','#4CAF50','#9E9E9E'],
        barThickness: 40
    }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { 
                beginAtZero: true,
                grid: { color: '#2b2b2b' }
            }
        },
        plugins: { 
            legend: { display: false }
        }
    }
});

const priorityCtxTop = document.getElementById('priorityChartTop').getContext('2d');
const priorityChartTop = new Chart(priorityCtxTop, {
    type: 'bar',
    data: { labels: Object.keys(priorityData), datasets: [{ 
        label:'Количество задач', 
        data: Object.values(priorityData), 
        backgroundColor:['#4CAF50','#FF9800','#F44336'],
        barThickness: 40
    }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { 
                beginAtZero: true,
                grid: { color: '#2b2b2b' }
            }
        },
        plugins: { 
            legend: { display: false }
        }
    }
});

const overdueCtxTop = document.getElementById('overdueChartTop').getContext('2d');
const overdueChartTop = new Chart(overdueCtxTop, {
    type: 'doughnut',
    data: { 
        labels: Object.keys(overdueByAssigneeTop), 
        datasets: [{ 
            data: Object.values(overdueByAssigneeTop), 
            backgroundColor: ['#F44336','#FF9800','#2196F3','#9E9E9E']
        }] 
    },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
            legend: { 
                position: 'bottom',
                align: 'center'
            }
        }
    }
});

// Top overlays: show 'no data' overlay and dim charts when needed
(function initTopOverlays(){
    const statusTopHas = Object.values(statusData).length > 0;
    const priorityTopHas = Object.values(priorityData).length > 0;
    const overdueTopHas = Object.keys(overdueByAssigneeTop).length > 0;

    const statusCanvasTop = document.getElementById('statusChartTop');
    const priorityCanvasTop = document.getElementById('priorityChartTop');
    const overdueCanvasTop = document.getElementById('overdueChartTop');

    const statusOverlayTop = document.getElementById('statusNoDataTop');
    const priorityOverlayTop = document.getElementById('priorityNoDataTop');
    const overdueOverlayTop = document.getElementById('overdueNoDataTop');

    statusOverlayTop.style.display = statusTopHas ? 'none' : 'flex';
    priorityOverlayTop.style.display = priorityTopHas ? 'none' : 'flex';
    overdueOverlayTop.style.display = overdueTopHas ? 'none' : 'flex';

    statusCanvasTop.style.opacity = statusTopHas ? '1' : '0.35';
    priorityCanvasTop.style.opacity = priorityTopHas ? '1' : '0.35';
    overdueCanvasTop.style.opacity = overdueTopHas ? '1' : '0.35';
})();

// Initialize BOTTOM charts (2 bars and 1 doughnut, updated from filtered table)
const statusCtx = document.getElementById('statusChartBottom').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'bar',
    data: { labels: [], datasets: [{ 
        label:'Количество задач',
        data: [], 
        backgroundColor: ['#2196F3','#FF9800','#4CAF50','#9E9E9E'],
        barThickness: 40
    }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { 
                beginAtZero: true,
                grid: { color: '#2b2b2b' }
            }
        },
        plugins: { 
            legend: { display: false }
        }
    }
});

const priorityCtx = document.getElementById('priorityChartBottom').getContext('2d');
const priorityChart = new Chart(priorityCtx, {
    type: 'bar',
    data: { labels: [], datasets: [{ 
        label:'Количество задач',
        data: [], 
        backgroundColor: ['#4CAF50','#FF9800','#F44336'],
        barThickness: 40
    }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { 
                beginAtZero: true,
                grid: { color: '#2b2b2b' }
            }
        },
        plugins: { 
            legend: { display: false }
        }
    }
});

const overdueCtx = document.getElementById('overdueChartBottom').getContext('2d');
const overdueChart = new Chart(overdueCtx, {
    type: 'doughnut',
    data: { 
        labels: [], 
        datasets: [{ 
            data: [], 
            backgroundColor: ['#F44336','#FF9800','#2196F3','#9E9E9E']
        }] 
    },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
            legend: { 
                position: 'bottom',
                align: 'center'
            }
        }
    }
});
</script>

<script>
// ----- Table filtering/sorting state -----
let filteredTasks = tasks.slice(); // current list shown in table (after filters/sorting)
let sortState = { index: null, asc: true };

function applyFilters(){
    const a = assigneeFilter.value;
    const s = statusFilter.value;
    filteredTasks = tasks.filter(t=>{
        if(a && (t.assignee||'') !== a) return false;
        if(s && (t.status||'') !== s) return false;
        return true;
    });
    // if currently sorted, keep sort order
    if(sortState.index !== null) {
        sortByColumn(sortState.index, sortState.asc);
    } else {
        renderTable(filteredTasks);
        updateChartsFromTasks(filteredTasks);
    }
}

// Sorting helper: column index and direction
function sortByColumn(colIndex, asc){
    const th = document.querySelectorAll('#tasksTable thead th')[colIndex];
    const type = th ? th.dataset.type : 'string';
    filteredTasks.sort((a,b)=>{
        let va, vb;
        switch(colIndex){
            case 0: // id
                va = Number(a.id||0); vb = Number(b.id||0); break;
            case 4: // date
                va = a.due_date ? new Date(a.due_date) : new Date(0);
                vb = b.due_date ? new Date(b.due_date) : new Date(0); break;
            case 1: // title
                va = (a.title||'').toString().toLowerCase(); vb = (b.title||'').toString().toLowerCase(); break;
            case 2: // assignee
                va = (a.assignee||'').toString().toLowerCase(); vb = (b.assignee||'').toString().toLowerCase(); break;
            case 3: // priority
                va = (a.priority||'').toString().toLowerCase(); vb = (b.priority||'').toString().toLowerCase(); break;
            case 5: // status
                va = (a.status||'').toString().toLowerCase(); vb = (b.status||'').toString().toLowerCase(); break;
            default:
                va = (a.title||'').toString().toLowerCase(); vb = (b.title||'').toString().toLowerCase();
        }
        if(va < vb) return asc ? -1 : 1;
        if(va > vb) return asc ? 1 : -1;
        return 0;
    });
    sortState = { index: colIndex, asc: asc };
    renderTable(filteredTasks);
    updateChartsFromTasks(filteredTasks);
}

// Attach click handlers to headers for sorting
document.addEventListener('DOMContentLoaded', ()=>{
    const headers = document.querySelectorAll('#tasksTable thead th');
    headers.forEach((th, idx)=>{
        th.style.userSelect = 'none';
        th.addEventListener('click', ()=>{
            const asc = (sortState.index === idx) ? !sortState.asc : true;
            sortByColumn(idx, asc);
            // simple visual indicator
            headers.forEach(h=> h.classList.remove('sorted-asc','sorted-desc'));
            th.classList.add(asc ? 'sorted-asc' : 'sorted-desc');
        });
    });
    // initial render
    renderTable(filteredTasks);
    updateChartsFromTasks(filteredTasks);
});
</script>
</body>
</html>