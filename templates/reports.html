<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Отчёты</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        .metrics { display:flex; gap:20px; justify-content:center; margin:20px 0; }
        .metric { text-align:center; padding:10px 15px; background:#1e1e1e; border-radius:8px; }
        .metric .number { font-size:20px; font-weight:700; }
        .chart-container { background:#121212; padding:12px; border-radius:8px; position:relative; }
        table { width:100%; border-collapse:collapse; margin-top:20px; }
        th, td { padding:8px 10px; border-bottom:1px solid #2b2b2b; }
        thead th { background:#151515; cursor:pointer; }
        canvas { max-height:100%; }
        .chart-canvas-wrap { position: relative; height: 140px; }
        .reports-page .no-data-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none; 
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background: rgba(0,0,0,0.65);
            color: #fff;
            font-style: normal;
            border-radius: 6px;
            pointer-events: none;
            z-index: 10;
            text-align: center;
            min-width: 80px;
        }
        .gantt-task {
            margin: 2px 0;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
        }
    </style>
</head>
<body>
<div class="container reports-page">
    <h1 style="text-align:center;">Отчёты</h1>
    <div style="text-align:center; margin-bottom:12px;"><a href="{{ url_for('index') }}">← Назад к задачам</a></div>

    <div class="metrics">
        <div class="metric">
            <div class="number">{{ total|default(0) }}</div>
            <div class="label">Всего задач</div>
        </div>
        <div class="metric">
            <div class="number" style="color:var(--accent-green);">{{ completed|default(0) }}</div>
            <div class="label">Выполнено</div>
        </div>
        <div class="metric">
            <div class="number" style="color:var(--accent-red);">{{ overdue|default(0) }}</div>
            <div class="label">Просрочено</div>
        </div>
        <div class="metric">
            <div class="number">{{ (total|default(0) - completed|default(0)) }}</div>
            <div class="label">Не выполнено</div>
        </div>
    </div>

    <div class="charts" style="margin:12px 0;display:flex;flex-wrap:wrap;gap:16px;justify-content:center;">
        <div style="display:flex;width:100%;gap:16px;justify-content:center;margin-bottom:16px;">
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
                <h3 style="text-align:center;margin:0 0 8px 0;">Распределение по статусам</h3>
                <div class="chart-canvas-wrap" style="height:140px;">
                    <canvas id="statusChartTop"></canvas>
                    <div id="statusNoDataTop" class="no-data-message">Нет данных для отображения</div>
                </div>
            </div>
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
                <h3 style="text-align:center;margin:0 0 8px 0;">Распределение по приоритетам</h3>
                <div class="chart-canvas-wrap" style="height:140px;">
                    <canvas id="priorityChartTop"></canvas>
                    <div id="priorityNoDataTop" class="no-data-message">Нет данных для отображения</div>
                </div>
            </div>
        </div>
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
            <h3 style="text-align:center;margin:0 0 8px 0;">Просроченные задачи</h3>
            <div class="chart-canvas-wrap" style="height:140px;">
                <canvas id="overdueChartTop"></canvas>
                <div id="overdueNoDataTop" class="no-data-message">Нет данных для отображения</div>
            </div>
        </div>
    </div>

    <h2 style="text-align:center; margin-top:36px;">Задачи</h2>
    <div style="text-align:center; margin:12px 0;">
        <label>Исполнитель: 
            <select id="assigneeFilter">
                <option value="">Все</option>
                {% for a in assignees %}
                <option value="{{ a }}">{{ a }}</option>
                {% endfor %}
            </select>
        </label>
        &nbsp;&nbsp;
        <label>Статус: 
            <select id="statusFilter">
                <option value="">Все</option>
                {% for s in statuses %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>
        </label>
    </div>

    <table id="tasksTable">
        <thead>
            <tr>
                <th data-type="number">ID</th>
                <th data-type="string">Название</th>
                <th data-type="string">Исполнитель</th>
                <th data-type="string">Приоритет</th>
                <th data-type="date">Срок</th>
                <th data-type="string">Статус</th>
            </tr>
        </thead>
        <tbody id="tasksBody">

        </tbody>
    </table>

</div>

    <div class="charts" style="margin:20px 0;display:flex;flex-wrap:wrap;gap:16px;justify-content:center;">
        <div style="display:flex;width:100%;gap:16px;justify-content:center;margin-bottom:16px;">
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
                <h3 style="text-align:center;margin:0 0 8px 0;">Распределение по статусам (по таблице)</h3>
                <div class="chart-canvas-wrap" style="height:140px;">
                    <canvas id="statusChartBottom"></canvas>
                    <div id="statusNoData" class="no-data-message" style="display:none;">Нет данных для отображения</div>
                </div>
            </div>
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
                <h3 style="text-align:center;margin:0 0 8px 0;">Распределение по приоритетам (по таблице)</h3>
                <div class="chart-canvas-wrap" style="height:140px;">
                    <canvas id="priorityChartBottom"></canvas>
                    <div id="priorityNoData" class="no-data-message" style="display:none;">Нет данных для отображения</div>
                </div>
            </div>
        </div>
            <div class="chart-container" style="width:45%;min-width:300px;max-width:450px;height:180px;">
            <h3 style="text-align:center;margin:0 0 8px 0;">Просроченные задачи (по таблице)</h3>
            <div class="chart-canvas-wrap" style="height:140px;">
                <canvas id="overdueChartBottom"></canvas>
                <div id="overdueNoData" class="no-data-message" style="display:none;">Нет данных для отображения</div>
            </div>
        </div>
    </div>

    <!-- Диаграмма Ганта -->
    <div style="margin-top: 40px; padding: 0 20px;">
        <h2 style="text-align:center;">Диаграмма Ганта</h2>
        <div class="chart-container" style="width: 100%; height: 500px; overflow-x: auto;">
            <div class="chart-canvas-wrap" style="height: 480px; min-width: 800px;">
                <canvas id="ganttChart"></canvas>
                <div id="ganttNoData" class="no-data-message">Нет данных для отображения диаграммы Ганта</div>
            </div>
        </div>
    </div>

{% if status_counts is defined %}
<script id="status-data" type="application/json">{{ status_counts | tojson | safe }}</script>
{% else %}
<script id="status-data" type="application/json">{}</script>
{% endif %}

{% if priority_counts is defined %}
<script id="priority-data" type="application/json">{{ priority_counts | tojson | safe }}</script>
{% else %}
<script id="priority-data" type="application/json">{}</script>
{% endif %}

{% if tasks is defined %}
<script id="tasks-data" type="application/json">{{ tasks | tojson | safe }}</script>
{% else %}
<script id="tasks-data" type="application/json">[]</script>
{% endif %}

<script>
const statusData = JSON.parse(document.getElementById('status-data').textContent || '{}');
const priorityData = JSON.parse(document.getElementById('priority-data').textContent || '{}');
const tasks = JSON.parse(document.getElementById('tasks-data').textContent || '[]');

function renderTable(list){
    const tbody = document.getElementById('tasksBody');
    tbody.innerHTML = '';
    list.forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${t.id}</td>
            <td><a href="/task/${t.id}">${escapeHtml(t.title||'')}</a></td>
            <td>${escapeHtml(t.assignee||'—')}</td>
            <td>${escapeHtml(t.priority||'')}</td>
            <td>${escapeHtml(t.due_date||'')}</td>
            <td>${escapeHtml(t.status||'')}</td>
        `;
        tbody.appendChild(tr);
    });
}

function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; });
}

const assigneeFilter = document.getElementById('assigneeFilter');
const statusFilter = document.getElementById('statusFilter');

let filteredTasks = tasks.slice(); 
let sortState = { index: null, asc: true };

function applyFilters(){
    const a = assigneeFilter.value;
    const s = statusFilter.value;
    filteredTasks = tasks.filter(t=>{
        if(a && (t.assignee||'') !== a) return false;
        if(s && (t.status||'') !== s) return false;
        return true;
    });
    if(sortState.index !== null) {
        sortByColumn(sortState.index, sortState.asc);
    } else {
        renderTable(filteredTasks);
        updateChartsFromTasks(filteredTasks);
    }
}

function sortByColumn(colIndex, asc){
    const th = document.querySelectorAll('#tasksTable thead th')[colIndex];
    const type = th ? th.dataset.type : 'string';
    filteredTasks.sort((a,b)=>{
        let va, vb;
        switch(colIndex){
            case 0: 
                va = Number(a.id||0); vb = Number(b.id||0); break;
            case 4: 
                va = a.due_date ? new Date(a.due_date) : new Date(0);
                vb = b.due_date ? new Date(b.due_date) : new Date(0); break;
            case 1:
                va = (a.title||'').toString().toLowerCase(); vb = (b.title||'').toString().toLowerCase(); break;
            case 2: 
                va = (a.assignee||'').toString().toLowerCase(); vb = (b.assignee||'').toString().toLowerCase(); break;
            case 3:
                va = (a.priority||'').toString().toLowerCase(); vb = (b.priority||'').toString().toLowerCase(); break;
            case 5: 
                va = (a.status||'').toString().toLowerCase(); vb = (b.status||'').toString().toLowerCase(); break;
            default:
                va = (a.title||'').toString().toLowerCase(); vb = (b.title||'').toString().toLowerCase();
        }
        if(va < vb) return asc ? -1 : 1;
        if(va > vb) return asc ? 1 : -1;
        return 0;
    });
    sortState = { index: colIndex, asc: asc };
    renderTable(filteredTasks);
    updateChartsFromTasks(filteredTasks);
}

// Диаграмма Ганта
function prepareGanttData(tasksList) {
    const tasksWithDates = tasksList.filter(task => task.due_date);
    
    if (tasksWithDates.length === 0) {
        return { tasks: [], assignees: [], dateRange: [] };
    }
    
    const sortedTasks = tasksWithDates.sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
    const assignees = [...new Set(sortedTasks.map(task => task.assignee || 'Не назначен'))];
    
    // Определяем диапазон дат
    const dates = sortedTasks.map(task => new Date(task.due_date));
    const minDate = new Date(Math.min(...dates));
    const maxDate = new Date(Math.max(...dates));
    
    // Добавляем немного места по краям
    minDate.setDate(minDate.getDate() - 2);
    maxDate.setDate(maxDate.getDate() + 2);
    
    return {
        tasks: sortedTasks,
        assignees: assignees,
        minDate: minDate,
        maxDate: maxDate
    };
}

function renderGanttChart(tasksList) {
    const ganttData = prepareGanttData(tasksList);
    const ctx = document.getElementById('ganttChart').getContext('2d');
    
    const hasData = ganttData.tasks.length > 0;
    const ganttCanvas = document.getElementById('ganttChart');
    const ganttOverlay = document.getElementById('ganttNoData');
    
    ganttOverlay.style.display = hasData ? 'none' : 'flex';
    ganttCanvas.style.opacity = hasData ? '1' : '0.35';
    
    if (!hasData) {
        if (window.ganttChartInstance) {
            window.ganttChartInstance.destroy();
        }
        return;
    }
    
    // Уничтожаем предыдущий график если есть
    if (window.ganttChartInstance) {
        window.ganttChartInstance.destroy();
    }
    
    // Создаем данные для диаграммы
    const datasets = ganttData.assignees.map((assignee, index) => {
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
        const color = colors[index % colors.length];
        
        const assigneeTasks = ganttData.tasks.filter(task => 
            (task.assignee || 'Не назначен') === assignee
        );
        
        const dataPoints = assigneeTasks.map(task => {
            const dueDate = new Date(task.due_date);
            // Создаем небольшой диапазон для отображения точки
            const startDate = new Date(dueDate);
            startDate.setDate(startDate.getDate() - 0.5);
            const endDate = new Date(dueDate);
            endDate.setDate(endDate.getDate() + 0.5);
            
            return {
                x: [startDate, endDate],
                y: assignee,
                task: task.title,
                status: task.status,
                priority: task.priority,
                due_date: task.due_date
            };
        });
        
        return {
            label: assignee,
            data: dataPoints,
            backgroundColor: color + '80', // добавляем прозрачность
            borderColor: color,
            borderWidth: 2,
            barPercentage: 0.6,
            categoryPercentage: 0.8
        };
    });
    
    window.ganttChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            datasets: datasets
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        tooltipFormat: 'dd.MM.yyyy',
                        displayFormats: {
                            day: 'dd.MM'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Дата выполнения'
                    },
                    min: ganttData.minDate,
                    max: ganttData.maxDate,
                    grid: {
                        color: '#2b2b2b'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Исполнители'
                    },
                    grid: {
                        color: '#2b2b2b'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#ffffff'
                    }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const task = context[0].raw;
                            return task.task;
                        },
                        label: function(context) {
                            const task = context.raw;
                            return [
                                `Исполнитель: ${task.y}`,
                                `Срок: ${task.due_date}`,
                                `Статус: ${task.status}`,
                                `Приоритет: ${task.priority}`
                            ];
                        }
                    }
                }
            }
        }
    });
}

function updateChartsFromTasks(list){
    const sc = {};
    const pc = {};
    const overdueByAssignee = {};
    const now = new Date(); now.setHours(0,0,0,0);
    list.forEach(t=>{
        const status = t.status || '—'; sc[status] = (sc[status]||0)+1;
        const pr = t.priority || '—'; pc[pr] = (pc[pr]||0)+1;
        if(t.due_date && t.status !== 'Готово'){
            const due = new Date(t.due_date);
            if(due < now){ const a = t.assignee||'Не назначен'; overdueByAssignee[a] = (overdueByAssignee[a]||0)+1; }
        }
    });

    const hasStatus = Object.values(sc).length > 0;
    const statusCanvas = document.getElementById('statusChartBottom');
    const statusOverlay = document.getElementById('statusNoData');
    statusOverlay.style.display = hasStatus ? 'none' : 'flex';
    statusCanvas.style.opacity = hasStatus ? '1' : '0.35';
    statusChart.data.labels = Object.keys(sc);
    statusChart.data.datasets[0].data = Object.values(sc);
    statusChart.update();

    const hasPriority = Object.values(pc).length > 0;
    const priorityCanvas = document.getElementById('priorityChartBottom');
    const priorityOverlay = document.getElementById('priorityNoData');
    priorityOverlay.style.display = hasPriority ? 'none' : 'flex';
    priorityCanvas.style.opacity = hasPriority ? '1' : '0.35';
    priorityChart.data.labels = Object.keys(pc);
    priorityChart.data.datasets[0].data = Object.values(pc);
    priorityChart.update();

    const hasOverdue = Object.values(overdueByAssignee).length > 0;
    const overdueCanvas = document.getElementById('overdueChartBottom');
    const overdueOverlay = document.getElementById('overdueNoData');
    overdueOverlay.style.display = hasOverdue ? 'none' : 'flex';
    overdueCanvas.style.opacity = hasOverdue ? '1' : '0.35';
    overdueChart.data.labels = Object.keys(overdueByAssignee);
    overdueChart.data.datasets[0].data = Object.values(overdueByAssignee);
    overdueChart.update();

    // Обновляем диаграмму Ганта
    renderGanttChart(list);
}

// Инициализация графиков при загрузке
const overdueTasksTop = tasks.filter(t => t && t.due_date && t.status !== 'Готово' && new Date(t.due_date) < new Date(new Date().setHours(0,0,0,0)));
const overdueByAssigneeTop = {};
overdueTasksTop.forEach(t => {
    const a = t.assignee || 'Не назначен';
    overdueByAssigneeTop[a] = (overdueByAssigneeTop[a] || 0) + 1;
});

const statusCtxTop = document.getElementById('statusChartTop').getContext('2d');
const statusChartTop = new Chart(statusCtxTop, {
    type: 'bar',
    data: { labels: Object.keys(statusData), datasets: [{ 
        label:'Количество задач',
        data: Object.values(statusData), 
        backgroundColor: ['#2196F3','#FF9800','#4CAF50','#9E9E9E'],
        barThickness: 40
    }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { 
                beginAtZero: true,
                grid: { color: '#2b2b2b' }
            }
        },
        plugins: { 
            legend: { display: false }
        }
    }
});

const priorityCtxTop = document.getElementById('priorityChartTop').getContext('2d');
const priorityChartTop = new Chart(priorityCtxTop, {
    type: 'bar',
    data: { labels: Object.keys(priorityData), datasets: [{ 
        label:'Количество задач', 
        data: Object.values(priorityData), 
        backgroundColor:['#4CAF50','#FF9800','#F44336'],
        barThickness: 40
    }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { 
                beginAtZero: true,
                grid: { color: '#2b2b2b' }
            }
        },
        plugins: { 
            legend: { display: false }
        }
    }
});

const overdueCtxTop = document.getElementById('overdueChartTop').getContext('2d');
const overdueChartTop = new Chart(overdueCtxTop, {
    type: 'doughnut',
    data: { 
        labels: Object.keys(overdueByAssigneeTop), 
        datasets: [{ 
            data: Object.values(overdueByAssigneeTop), 
            backgroundColor: ['#F44336','#FF9800','#2196F3','#9E9E9E']
        }] 
    },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
            legend: { 
                position: 'bottom',
                align: 'center'
            }
        }
    }
});

// Инициализация графиков для фильтруемой таблицы
const statusCtx = document.getElementById('statusChartBottom').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'bar',
    data: { labels: [], datasets: [{ 
        label:'Количество задач',
        data: [], 
        backgroundColor: ['#2196F3','#FF9800','#4CAF50','#9E9E9E'],
        barThickness: 40
    }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { 
                beginAtZero: true,
                grid: { color: '#2b2b2b' }
            }
        },
        plugins: { 
            legend: { display: false }
        }
    }
});

const priorityCtx = document.getElementById('priorityChartBottom').getContext('2d');
const priorityChart = new Chart(priorityCtx, {
    type: 'bar',
    data: { labels: [], datasets: [{ 
        label:'Количество задач',
        data: [], 
        backgroundColor: ['#4CAF50','#FF9800','#F44336'],
        barThickness: 40
    }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: { 
            y: { 
                beginAtZero: true,
                grid: { color: '#2b2b2b' }
            }
        },
        plugins: { 
            legend: { display: false }
        }
    }
});

const overdueCtx = document.getElementById('overdueChartBottom').getContext('2d');
const overdueChart = new Chart(overdueCtx, {
    type: 'doughnut',
    data: { 
        labels: [], 
        datasets: [{ 
            data: [], 
            backgroundColor: ['#F44336','#FF9800','#2196F3','#9E9E9E']
        }] 
    },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
            legend: { 
                position: 'bottom',
                align: 'center'
            }
        }
    }
});

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', ()=>{
    const headers = document.querySelectorAll('#tasksTable thead th');
    headers.forEach((th, idx)=>{
        th.style.userSelect = 'none';
        th.addEventListener('click', ()=>{
            const asc = (sortState.index === idx) ? !sortState.asc : true;
            sortByColumn(idx, asc);
            headers.forEach(h=> h.classList.remove('sorted-asc','sorted-desc'));
            th.classList.add(asc ? 'sorted-asc' : 'sorted-desc');
        });
    });
    
    renderTable(filteredTasks);
    updateChartsFromTasks(filteredTasks);
    
    // Инициализация оверлеев для верхних графиков
    const statusTopHas = Object.values(statusData).length > 0;
    const priorityTopHas = Object.values(priorityData).length > 0;
    const overdueTopHas = Object.keys(overdueByAssigneeTop).length > 0;

    const statusOverlayTop = document.getElementById('statusNoDataTop');
    const priorityOverlayTop = document.getElementById('priorityNoDataTop');
    const overdueOverlayTop = document.getElementById('overdueNoDataTop');

    statusOverlayTop.style.display = statusTopHas ? 'none' : 'flex';
    priorityOverlayTop.style.display = priorityTopHas ? 'none' : 'flex';
    overdueOverlayTop.style.display = overdueTopHas ? 'none' : 'flex';

    document.getElementById('statusChartTop').style.opacity = statusTopHas ? '1' : '0.35';
    document.getElementById('priorityChartTop').style.opacity = priorityTopHas ? '1' : '0.35';
    document.getElementById('overdueChartTop').style.opacity = overdueTopHas ? '1' : '0.35';
});

// Назначаем обработчики событий
assigneeFilter.addEventListener('change', applyFilters);
statusFilter.addEventListener('change', applyFilters);
</script>
</body>
</html>
